<%= render 'list_head', list: @list %>

<h2 class= "list-title"><%= @list.name %></h2>
<div class="list-nav">
  by <%= link_to @list.owner.username, user_lists_path(@list.owner) %>
  <% if current_user %>
    <% if current_user.can_edit? @list %>
     - <%= link_to 'Edit', edit_user_list_path(@list.owner, @list) %>
   <% end %>
    <% if @list.owner == current_user %>
       - <%= link_to 'Delete List', user_list_path(@list.owner, @list), data: { confirm: 'Are you sure?' }, method: :delete %>
    <% end %>
  <% end %>

  <% if @list.access == 'contributors' %>
   <span data-toggle="tooltip" data-placement="right" title="Only contibutors may edit or add references to this list"> üîí </span>
  <% else %>
    <span data-toggle="tooltip" data-placement="right" title="Anyone may edit or add references to this list"> üåé </span>
  <% end %>

</div>

<div class="container" id='list-show'>
  <div class="row">
    <div class="col-md-8">
      <p>
        <% @list.tag_list.each do |tag| %>
          <a class="btn btn-default btn-xs"><%= tag %></a>
        <% end %>
      </p>
      <strong>Description</strong>
      <%= transform_text @list.description %>
      <%= render 'crossref/search', list: @list %>
      <%= render 'lists/add_reference', list: @list %>
      <% reference_count = @list.references.count %>
      <% if reference_count > 0 %>
        <%= render 'papers/sort_by' %>
        <i><%= reference_count%> papers added to this list</i>
      <% end %>
      <%= render partial: 'references/reference', collection: @references, locals: {show_comments: false} %>
    </div>
    <div class="col-md-4 list-comments">
      <strong>Comments on <%= @list.name %></strong>
      <div id="comments-<%= @list.id %>">
        <%= render 'commentables/comments', commentable: @list, list_for_authorization: @list %>
      </div>
    </div>
  </div>
  <button v-if="showPopup" class="highlight-popup" :style="{left: position().left, top: position().top}">üñäÔ∏è</button>
</div>

<% content_for(:page_app) do %>
  <script>
    var HighlightableText = {
      template: `
        <div class="highlightable-text" @mouseup="showPopup">
          <slot></slot>
        </div>
      `,
      methods: {
        showPopup() {
          var selection = window.getSelection().toString()
          if (selection.length > 1 && selection.match(/[^\s]/)) {
            this.$emit('show-popup')
          } else {
            this.$emit('hide-popup')
          }
        }
      }
    }

    var listShow = new Vue({
      el: '#list-show',
      data: {
        showPopup: false
      },
      components: {
        'highlightable-text': HighlightableText
      },
      methods: {
        position() {
          var range = window.getSelection().getRangeAt(0)
          var rect = range.getBoundingClientRect()
          var popupWidth = 30
          var popupHeight = 30

          return {
            left: rect.left + window.scrollX + (rect.width / 2) - (popupWidth / 2) + 'px',
            top: rect.top + window.scrollY - popupHeight + 'px'
          }
        }
      }
    })
  </script>
<% end %>
